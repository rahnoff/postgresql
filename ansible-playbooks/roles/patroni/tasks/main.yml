- name: Render Patroni config
  ansible.builtin.template:
    dest: /etc/patroni.yml
    src: patroni.yml.j2

- name: Create Patroni log directory and file
  ansible.builtin.file:
    group: postgres
    mode: '{{ item.mode }}'
    owner: postgres
    path: '{{ item.path }}'
    state: '{{ item.state }}'
  loop:
    - { mode: '0700', path: '/var/log/patroni', state: 'directory' }
    - { mode: '0600', path: '/var/log/patroni/patroni.log', state: 'touch' }

- name: Copy Patroni systemd unit file
  ansible.builtin.copy:
    dest: /etc/systemd/system
    src: patroni.service

- name: Extract Patroni
  ansible.builtin.unarchive:
    dest: /usr/local/bin
    group: root
    owner: root
    src: patroni.tar.gz

- name: Reread systemd configs
  ansible.builtin.systemd_service:
    daemon_reload: true

- name: Start and enable Patroni
  ansible.builtin.systemd_service:
    enabled: true
    masked: false
    name: patroni
    state: started
